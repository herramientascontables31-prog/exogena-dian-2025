<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conciliaci√≥n Bancaria ‚Äî Ex√≥genaDIAN</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--g700:#047857;--g600:#059669;--g500:#10B981;--g400:#34D399;--g200:#A7F3D0;--g100:#D1FAE5;--g50:#ECFDF5;--w:#FFF;--f50:#F9FAFB;--f100:#F3F4F6;--f200:#E5E7EB;--f300:#D1D5DB;--f400:#9CA3AF;--f500:#6B7280;--f600:#4B5563;--f700:#374151;--f800:#1F2937;--f900:#111827;--blue:#3B82F6;--amber:#F59E0B;--red:#EF4444;--r:14px}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Outfit',sans-serif;background:var(--f50);color:var(--f900);min-height:100vh}
.nav{display:flex;align-items:center;justify-content:space-between;padding:14px 32px;background:var(--w);border-bottom:1px solid var(--f200)}.nav-logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--f900);font-weight:800;font-size:1.1rem}.nav-mark{width:30px;height:30px;background:linear-gradient(135deg,var(--g600),var(--g400));border-radius:8px;display:grid;place-items:center;color:#fff;font-size:.75rem;font-weight:900}.nav-logo small{font-weight:400;font-size:.6rem;color:var(--f400);display:block}.nav a.back{font-size:.85rem;color:var(--f500);text-decoration:none}
.container{max-width:1180px;margin:0 auto;padding:32px 24px}.page-header{margin-bottom:28px}.page-header h1{font-family:'Fraunces',serif;font-size:1.8rem;font-weight:700;margin-bottom:6px}.page-header p{color:var(--f500);font-size:.95rem;line-height:1.55}
.page-badge{display:inline-flex;align-items:center;gap:6px;background:var(--g50);border:1px solid var(--g200);padding:4px 12px;border-radius:8px;font-size:.75rem;font-weight:600;color:var(--g700);margin-bottom:12px}.page-badge::before{content:'üè¶';font-size:.85rem}
.security{display:flex;align-items:flex-start;gap:14px;padding:18px 20px;background:linear-gradient(135deg,#FFFBEB,#FEF3C7);border:1px solid #FDE68A;border-radius:14px;margin-bottom:24px}.sec-icon{font-size:1.6rem;flex-shrink:0;margin-top:2px}.sec-content strong{font-size:.9rem;color:#78350F;display:block;margin-bottom:4px}.sec-content p{font-size:.8rem;color:#92400E;line-height:1.55;margin:0}
.card{background:var(--w);border-radius:var(--r);border:1px solid var(--f200);padding:24px;margin-bottom:20px}.card-title{font-size:1rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card-info{font-size:.78rem;color:var(--g700);background:var(--g50);padding:8px 12px;border-radius:8px;margin-bottom:12px;border-left:3px solid var(--g400)}
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.drop-zone{border:2px dashed var(--f300);border-radius:var(--r);padding:36px 20px;text-align:center;cursor:pointer;transition:all .25s;position:relative;background:var(--w)}.drop-zone:hover,.drop-zone.dragover{border-color:var(--g400);background:var(--g50)}.drop-zone.loaded{border-color:var(--g500);border-style:solid;background:var(--g50)}.drop-zone .dz-icon{font-size:2.2rem;margin-bottom:8px;display:block}.drop-zone .dz-title{font-size:.9rem;font-weight:700;margin-bottom:4px}.drop-zone .dz-hint{font-size:.76rem;color:var(--f400)}.drop-zone .dz-file{font-size:.8rem;color:var(--g700);font-weight:600;margin-top:8px}.drop-zone .dz-rows{font-size:.72rem;color:var(--f400);margin-top:2px}.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}.drop-zone .dz-clear{position:absolute;top:8px;right:8px;background:var(--f100);border:none;border-radius:6px;padding:4px 8px;font-size:.7rem;font-weight:600;color:var(--f500);cursor:pointer;display:none;z-index:2}.drop-zone.loaded .dz-clear{display:block}
.raw-preview{overflow-x:auto;border:1px solid var(--f200);border-radius:10px;max-height:260px;overflow-y:auto;margin:10px 0;font-size:.7rem}.raw-preview table{width:100%;border-collapse:collapse}.raw-preview th{background:var(--f100);padding:5px 7px;text-align:left;font-weight:700;color:var(--f500);border-bottom:1px solid var(--f200);white-space:nowrap;position:sticky;top:0;z-index:1}.raw-preview td{padding:4px 7px;border-bottom:1px solid var(--f100);white-space:nowrap;max-width:160px;overflow:hidden;text-overflow:ellipsis}
.raw-preview tr.rSkip td{background:var(--f50);color:var(--f400);font-style:italic}.raw-preview tr.rHead td{background:#DBEAFE;color:#1E40AF;font-weight:700}.raw-preview tr.rData td{background:var(--w);color:var(--f700)}
.raw-preview td.rn{background:var(--f100);color:var(--f400);font-weight:700;text-align:center;width:30px;min-width:30px;font-size:.65rem;position:sticky;left:0;z-index:1}
.ctrl-row{display:flex;flex-wrap:wrap;gap:12px;margin:10px 0;align-items:end}.ctrl-item{display:flex;flex-direction:column;gap:2px}.ctrl-item label{font-size:.7rem;font-weight:700;color:var(--f500);text-transform:uppercase;letter-spacing:.3px}
.ctrl-item select,.ctrl-item input[type=number]{padding:5px 10px;border-radius:8px;border:1px solid var(--f300);font-family:'Outfit',sans-serif;font-size:.82rem;background:var(--w)}.ctrl-item input[type=number]{width:70px}
.ctrl-item input[type=checkbox]{width:16px;height:16px;accent-color:var(--g500)}
.col-map{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}.col-map .map-item{flex:1;min-width:120px}.col-map label{font-size:.72rem;font-weight:600;color:var(--f600)}.col-map select{padding:5px 8px;border-radius:8px;border:1px solid var(--f300);font-family:'Outfit',sans-serif;font-size:.76rem;margin-top:2px;display:block;width:100%;background:var(--w)}.col-map select.mapped{border-color:var(--g500);background:var(--g50)}
.parsed-preview{overflow-x:auto;border:1px solid var(--g200);border-radius:10px;margin:10px 0;background:var(--g50)}.parsed-preview table{width:100%;border-collapse:collapse;font-size:.72rem}.parsed-preview th{background:var(--g100);padding:6px 8px;text-align:left;font-weight:700;color:var(--g700);border-bottom:1px solid var(--g200)}.parsed-preview td{padding:5px 8px;border-bottom:1px solid var(--g100);color:var(--f700)}.parsed-preview .num{text-align:right;font-variant-numeric:tabular-nums}.parsed-preview .ok{color:var(--g600)}.parsed-preview .warn{color:var(--amber)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 22px;border-radius:12px;font-family:'Outfit',sans-serif;font-weight:600;font-size:.9rem;transition:all .2s;cursor:pointer;border:none;text-decoration:none}.btn-primary{background:var(--g600);color:#fff}.btn-primary:hover{background:var(--g700);transform:translateY(-1px);box-shadow:0 4px 14px rgba(5,150,105,.25)}.btn-primary:disabled{background:var(--f300);cursor:not-allowed;transform:none;box-shadow:none}.btn-outline{background:transparent;color:var(--f700);border:1.5px solid var(--f200)}.btn-outline:hover{border-color:var(--g400);color:var(--g700)}.actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
.summary{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}.summary-card{background:var(--w);border-radius:12px;padding:18px 16px;border:1px solid var(--f200);text-align:center}.sc-val{font-size:1.4rem;font-weight:800;line-height:1;margin-bottom:3px}.sc-label{font-size:.72rem;color:var(--f400);font-weight:500}.sc-green .sc-val{color:var(--g600)}.sc-blue .sc-val{color:var(--blue)}.sc-amber .sc-val{color:var(--amber)}.sc-red .sc-val{color:var(--red)}
.recon-summary{background:var(--w);border:1.5px solid var(--f200);border-radius:var(--r);padding:20px 24px;margin-bottom:20px}.recon-summary h3{font-size:.95rem;font-weight:700;margin-bottom:12px}.rr{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:.85rem;border-bottom:1px dashed var(--f200)}.rr:last-child{border-bottom:none;font-weight:800;padding-top:10px;font-size:.9rem}.rr-l{color:var(--f600)}.rr-v{font-variant-numeric:tabular-nums;font-weight:600}.rr-pos{color:var(--g700)}.rr-neg{color:var(--red)}.rr-bold{font-weight:800;font-size:.95rem}
.results-tabs{display:flex;gap:0;border-bottom:2px solid var(--f200)}.results-tab{padding:10px 20px;font-size:.85rem;font-weight:600;cursor:pointer;border:none;background:none;color:var(--f400);border-bottom:2px solid transparent;margin-bottom:-2px;font-family:'Outfit',sans-serif}.results-tab.active{color:var(--g700);border-bottom-color:var(--g500)}.tab-count{background:var(--f100);padding:1px 7px;border-radius:6px;font-size:.72rem;margin-left:4px}.results-tab.active .tab-count{background:var(--g100);color:var(--g700)}
.results-panel{display:none}.results-panel.active{display:block}.results-scroll{max-height:520px;overflow-y:auto;border:1px solid var(--f200);border-radius:0 0 10px 10px}
.rtable{width:100%;border-collapse:collapse;font-size:.74rem}.rtable th{background:var(--f50);padding:8px 10px;text-align:left;font-weight:700;color:var(--f500);border-bottom:2px solid var(--f200);position:sticky;top:0;white-space:nowrap;z-index:1}.rtable td{padding:6px 10px;border-bottom:1px solid var(--f100);color:var(--f700)}.rtable tr:hover td{background:#F0FFF4}
.num{text-align:right;font-variant-numeric:tabular-nums;font-weight:500}.conf{display:inline-block;padding:2px 8px;border-radius:6px;font-size:.65rem;font-weight:700}.conf-alta{background:var(--g100);color:var(--g700)}.conf-media{background:#DBEAFE;color:#1E40AF}.conf-baja{background:#FEF3C7;color:#92400E}
.tipo-in{color:var(--g600);font-weight:700}.tipo-out{color:var(--red);font-weight:700}.desc-cell{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.paywall{text-align:center;padding:40px 20px;background:linear-gradient(180deg,var(--w),var(--f50));border-radius:var(--r);border:1.5px dashed var(--f300);margin-top:16px}.paywall h3{font-size:1rem;font-weight:700;margin-bottom:6px}.paywall p{font-size:.85rem;color:var(--f500);margin-bottom:16px}
.pricing-mini{display:flex;justify-content:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}.pm-opt{background:var(--w);border:1.5px solid var(--f200);border-radius:10px;padding:12px 18px;text-align:center;min-width:120px}.pm-opt.selected{border-color:var(--g400);background:var(--g50)}.pm-rows{font-size:.72rem;color:var(--f400);font-weight:600}.pm-price{font-size:1.1rem;font-weight:800;color:var(--g700)}.pm-unit{font-size:.68rem;color:var(--f400)}
.steps-indicator{display:flex;align-items:center;gap:0;margin-bottom:28px}.step-ind{display:flex;align-items:center;gap:8px;padding:8px 16px;font-size:.82rem;font-weight:600;color:var(--f400)}.step-ind.active{color:var(--g700)}.step-ind.done{color:var(--g500)}.step-num{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-size:.75rem;font-weight:800;background:var(--f100);color:var(--f400)}.step-ind.active .step-num{background:var(--g500);color:#fff}.step-ind.done .step-num{background:var(--g100);color:var(--g700)}.step-arrow{color:var(--f300);font-size:.7rem;margin:0 4px}
.disclaimer-footer{margin-top:20px;padding:14px 18px;background:var(--f50);border:1px solid var(--f200);border-radius:10px;text-align:center}.disclaimer-footer p{font-size:.76rem;color:var(--f400);margin:0;line-height:1.5}
.analysis-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.analysis-card{background:var(--w);border-radius:var(--r);border:1px solid var(--f200);padding:20px;overflow:hidden}
.analysis-card h3{font-size:.88rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.cat-list{list-style:none;padding:0;margin:0}
.cat-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--f100);font-size:.82rem}
.cat-item:last-child{border-bottom:none}
.cat-icon{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;font-size:.8rem;flex-shrink:0}
.cat-left{display:flex;align-items:center;gap:10px}
.cat-name{font-weight:600;color:var(--f700)}.cat-count{font-size:.68rem;color:var(--f400);font-weight:500}
.cat-val{font-weight:700;font-variant-numeric:tabular-nums;font-size:.85rem}
.cat-val.val-red{color:var(--red)}.cat-val.val-green{color:var(--g600)}.cat-val.val-amber{color:var(--amber)}
.cat-total{display:flex;justify-content:space-between;padding:10px 0 0;margin-top:6px;border-top:2px solid var(--f200);font-weight:800;font-size:.88rem}
.bridge{background:var(--w);border-radius:var(--r);border:1.5px solid var(--f200);padding:24px;margin-bottom:20px}
.bridge h3{font-size:.95rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.bridge-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;font-size:.85rem;border-radius:8px;margin-bottom:4px}
.bridge-row.br-start{background:var(--g50);font-weight:700;border:1px solid var(--g200)}
.bridge-row.br-end{background:var(--g50);font-weight:800;border:1px solid var(--g200);font-size:.9rem;margin-top:8px}
.bridge-row.br-add{background:#EFF6FF;border:1px solid #BFDBFE;color:#1E40AF}
.bridge-row.br-sub{background:#FEF2F2;border:1px solid #FECACA;color:#991B1B}
.bridge-row.br-sep{border:none;padding:4px 12px;font-size:.72rem;color:var(--f400);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-top:8px}
.br-label{flex:1}.br-val{font-variant-numeric:tabular-nums;font-weight:700;text-align:right;min-width:120px}
.bridge-check{display:flex;align-items:center;gap:8px;margin-top:12px;padding:10px 14px;border-radius:10px;font-size:.82rem;font-weight:700}
.bridge-check.ok{background:var(--g50);color:var(--g700);border:1px solid var(--g200)}
.bridge-check.diff{background:#FEF2F2;color:#991B1B;border:1px solid #FECACA}
.hidden{display:none}
@media(max-width:768px){.upload-grid{grid-template-columns:1fr}.summary{grid-template-columns:1fr 1fr}.col-map{flex-direction:column}.container{padding:20px 16px}.ctrl-row{flex-direction:column}}
</style>
</head>
<body>
<nav class="nav"><a href="index.html" class="nav-logo"><div class="nav-mark">E</div><div>Ex√≥genaDIAN<small>Portal Contable</small></div></a><a href="index.html" class="back">‚Üê Volver al inicio</a></nav>
<div class="container">
<div class="page-header"><div class="page-badge">Conciliaci√≥n Bancaria Autom√°tica</div><h1>Concilia extracto vs libro auxiliar</h1><p>Sube ambos archivos en Excel o CSV. La herramienta detecta autom√°ticamente la estructura y te permite verificar antes de procesar.</p></div>
<div class="security"><div class="sec-icon">üîí</div><div class="sec-content"><strong>Tu informaci√≥n est√° 100% protegida</strong><p>Esta herramienta funciona completamente en tu navegador. Tus archivos <u>nunca se suben a ning√∫n servidor</u>, no se transmiten por internet y no quedan almacenados. Ni Ex√≥genaDIAN ni terceros acceden a tu informaci√≥n financiera. Al cerrar la pesta√±a, todo desaparece.</p></div></div>
<div class="steps-indicator"><div class="step-ind active" id="si1"><div class="step-num">1</div> Subir</div><div class="step-arrow">‚Üí</div><div class="step-ind" id="si2"><div class="step-num">2</div> Verificar</div><div class="step-arrow">‚Üí</div><div class="step-ind" id="si3"><div class="step-num">3</div> Resultados</div></div>

<div id="step1">
<div class="upload-grid">
<div class="drop-zone" id="dzE"><input type="file" accept=".xlsx,.xls,.csv,.tsv,.txt" id="fE"><button class="dz-clear" onclick="clearFile('E');event.stopPropagation()">‚úï</button><span class="dz-icon">üè¶</span><div class="dz-title">Extracto Bancario</div><div class="dz-hint">Excel o CSV ¬∑ Bancolombia, Davivienda, Bogot√°, otros</div><div class="dz-file" id="nE"></div><div class="dz-rows" id="rE"></div></div>
<div class="drop-zone" id="dzA"><input type="file" accept=".xlsx,.xls,.csv,.tsv,.txt" id="fA"><button class="dz-clear" onclick="clearFile('A');event.stopPropagation()">‚úï</button><span class="dz-icon">üìí</span><div class="dz-title">Libro Auxiliar Contable</div><div class="dz-hint">Excel o CSV ¬∑ Siigo, World Office, Helisa, otros</div><div class="dz-file" id="nA"></div><div class="dz-rows" id="rA"></div></div>
</div>
<div class="actions"><button class="btn btn-primary" id="btnNext" disabled onclick="goStep2()">Continuar ‚Üí Verificar columnas</button></div>
</div>

<div id="step2" class="hidden">
<div class="card" id="cardE"></div>
<div class="card" id="cardA"></div>
<div class="card"><div class="card-title">‚öôÔ∏è Opciones de cruce</div>
<div class="ctrl-row"><div class="ctrl-item"><label>Tolerancia monto</label><select id="optTol"><option value="0">Exacto</option><option value="1" selected>¬± $1</option><option value="10">¬± $10</option><option value="100">¬± $100</option><option value="500">¬± $500</option></select></div></div></div>
<div class="actions"><button class="btn btn-outline" onclick="goStep1()">‚Üê Volver</button><button class="btn btn-primary" onclick="ejecutar()">üîÑ Conciliar</button></div>
</div>

<div id="step3" class="hidden">
<div class="summary" id="sumCards"></div><div id="reconBox"></div><div id="analysisBox"></div>
<div class="card" style="padding:0;overflow:hidden"><div class="results-tabs" id="rTabs"></div><div id="rPanels"></div></div>
<div id="payZone"></div>
<div class="actions"><button class="btn btn-outline" onclick="goStep1()">‚Üê Nueva conciliaci√≥n</button><button class="btn btn-primary" id="btnXls" onclick="exportXls()">üì• Descargar Excel</button></div>
<div class="disclaimer-footer"><p>üîí Ning√∫n dato fue enviado, almacenado ni procesado fuera de tu navegador. Al cerrar esta pesta√±a, toda la informaci√≥n se elimina autom√°ticamente.</p></div>
</div>
</div>
<script>
/* ========================================================================
   CONCILIACI√ìN BANCARIA v3 ‚Äî FINAL BULLETPROOF
   ======================================================================== */
const FREE_LIMIT = 500;
const PRICING = [{max:50,price:0},{max:200,price:3000,label:'$3.000'},{max:500,price:5000,label:'$5.000'},{max:999999,price:10000,label:'$10.000'}];

const F = {
  E: {raw:null,display:null,headerRow:0,noHeader:false,numFmt:'auto',map:{},name:''},
  A: {raw:null,display:null,headerRow:0,noHeader:false,numFmt:'auto',map:{},name:''}
};
let resultados = null;

/* ‚îÄ‚îÄ 1. FILE READING ‚îÄ‚îÄ */
['E','A'].forEach(k => {
  const dz = document.getElementById('dz'+k);
  const inp = document.getElementById('f'+k);
  ['dragover','dragenter'].forEach(ev => dz.addEventListener(ev, e => {e.preventDefault();dz.classList.add('dragover')}));
  ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => {e.preventDefault();dz.classList.remove('dragover')}));
  dz.addEventListener('drop', e => {if(e.dataTransfer.files[0]) readFile(e.dataTransfer.files[0], k)});
  inp.addEventListener('change', e => {if(e.target.files[0]) readFile(e.target.files[0], k)});
});

function readFile(file, k) {
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const wb = XLSX.read(ev.target.result, {type:'array', cellDates:true});
      let best = null, bestN = 0;
      for (const sn of wb.SheetNames) {
        const raw = XLSX.utils.sheet_to_json(wb.Sheets[sn], {header:1, defval:'', raw:true});
        const disp = XLSX.utils.sheet_to_json(wb.Sheets[sn], {header:1, defval:'', raw:false});
        const n = raw.filter(r => r.some(c => c !== '' && c != null)).length;
        if (n > bestN) { best = {sn, raw, disp}; bestN = n; }
      }
      if (!best || bestN < 2) { alert('El archivo parece vac√≠o o no tiene datos suficientes.'); return; }
      const rawClean = [], dispClean = [];
      for (let i = 0; i < best.raw.length; i++) {
        if (best.raw[i].some(c => c !== '' && c != null)) {
          rawClean.push(best.raw[i]);
          dispClean.push(best.disp[i] || best.raw[i]);
        }
      }
      F[k].raw = rawClean;
      F[k].display = dispClean;
      F[k].name = file.name;
      F[k].headerRow = findBestHeaderRow(rawClean);
      F[k].noHeader = false;
      F[k].numFmt = 'auto';
      document.getElementById('n'+k).textContent = file.name;
      document.getElementById('r'+k).textContent = rawClean.length + ' filas ¬∑ hoja: ' + best.sn;
      document.getElementById('dz'+k).classList.add('loaded');
      checkReady();
    } catch(err) {
      alert('Error al leer el archivo: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function clearFile(k) {
  F[k].raw = null; F[k].display = null;
  document.getElementById('f'+k).value = '';
  document.getElementById('n'+k).textContent = '';
  document.getElementById('r'+k).textContent = '';
  document.getElementById('dz'+k).classList.remove('loaded');
  checkReady();
}

function checkReady() {
  document.getElementById('btnNext').disabled = !(F.E.raw && F.A.raw);
}

/* ‚îÄ‚îÄ 2. HEADER ROW DETECTION ‚îÄ‚îÄ */
const HEADER_KEYWORDS = /^(fecha|descripci|detalle|concepto|valor|monto|saldo|d[e√©]bito|cr[e√©]dito|referencia|documento|comprobante|cuenta|tercero|nombre|sucursal|dcto|c[o√≥]digo|tipo|abono|cargo|retiro|identificaci|movimiento|secuencia|centro|cheque|nro|desde|hasta)/i;

function findBestHeaderRow(rows) {
  let bestI = 0, bestScore = -Infinity;
  const limit = Math.min(rows.length, 30);
  for (let i = 0; i < limit; i++) {
    const r = rows[i];
    if (!r || r.length < 2) continue;
    let score = 0, filled = 0;
    for (const c of r) {
      if (c == null || c === '') continue;
      filled++;
      const s = String(c).trim();
      if (HEADER_KEYWORDS.test(s)) score += 10;
      else if (typeof c === 'string' && isNaN(Number(s.replace(/[,$.\-\s]/g,'')))) score += 1;
      else score -= 1;
    }
    score += filled * 0.5;
    if (i + 1 < rows.length) {
      const next = rows[i+1];
      if (next) {
        const nums = next.filter(c => typeof c === 'number' || (c && !isNaN(Number(String(c).replace(/[,$.\-\s]/g,''))))).length;
        if (nums >= 2) score += 5;
      }
    }
    if (score > bestScore) { bestScore = score; bestI = i; }
  }
  return bestI;
}

/* ‚îÄ‚îÄ 3. NUMBER FORMAT DETECTION & PARSING ‚îÄ‚îÄ */
function detectNumFormat(rows, colIdx) {
  let patCOL = 0, patUS = 0, patPlain = 0;
  for (let i = 0; i < Math.min(rows.length, 50); i++) {
    const c = rows[i][colIdx];
    if (c == null || c === '' || typeof c === 'number') { patPlain++; continue; }
    const s = String(c).trim().replace(/[$\s\-()]/g,'');
    if (!s || !/\d/.test(s)) continue;
    if (/^\d{1,3}(\.\d{3})+(,\d{1,2})?$/.test(s)) { patCOL++; continue; }
    if (/^\d{1,3}(,\d{3})+(\.\d{1,2})?$/.test(s)) { patUS++; continue; }
    if (/,\d{1,2}$/.test(s) && !s.includes('.')) { patCOL++; continue; }
    if (/\.\d{1,2}$/.test(s) && !s.includes(',')) { patUS++; continue; }
    patPlain++;
  }
  if (patCOL > patUS && patCOL > patPlain) return 'col';
  if (patUS > patCOL) return 'us';
  return 'plain';
}

function toNum(v, fmt) {
  if (typeof v === 'number') return v;
  if (v == null || v === '') return 0;
  let s = String(v).trim();
  if (/^[-‚Äì‚Äî]+$/.test(s)) return 0;
  s = s.replace(/[$COP\s]/gi, '');
  let neg = false;
  if (s.startsWith('(') && s.endsWith(')')) { neg = true; s = s.slice(1,-1); }
  if (s.startsWith('-')) { neg = true; s = s.substring(1); }
  s = s.trim();
  if (!s || !/\d/.test(s)) return 0;
  if (fmt === 'col') { s = s.replace(/\./g, '').replace(',', '.'); }
  else if (fmt === 'us') { s = s.replace(/,/g, ''); }
  else {
    if (s.includes('.') && s.includes(',')) {
      const lastDot = s.lastIndexOf('.'), lastComma = s.lastIndexOf(',');
      if (lastComma > lastDot) s = s.replace(/\./g,'').replace(',','.');
      else s = s.replace(/,/g,'');
    } else if (s.includes(',')) {
      const afterComma = s.split(',').pop();
      if (afterComma.length <= 2) s = s.replace(',','.');
      else s = s.replace(/,/g,'');
    } else if (s.includes('.')) {
      const parts = s.split('.');
      if (parts.length > 2) s = s.replace(/\./g,'');
    }
  }
  s = s.replace(/[^\d.]/g, '');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : (neg ? -n : n);
}

/* ‚îÄ‚îÄ 4. DATE PARSING ‚îÄ‚îÄ */
function guessYearFromTransactions(rows, colIdx, dataStart) {
  const yearCounts = {};
  for (let i = dataStart; i < Math.min(rows.length, dataStart + 100); i++) {
    const c = rows[i] ? rows[i][colIdx] : null;
    if (!c) continue;
    if (c instanceof Date && !isNaN(c)) { const y = c.getFullYear(); if (y >= 2020 && y <= 2035) yearCounts[y] = (yearCounts[y]||0) + 5; continue; }
    const s = String(c);
    const matches = s.match(/20[2-3]\d/g);
    if (matches) matches.forEach(y => yearCounts[y] = (yearCounts[y]||0) + 1);
    if (typeof c === 'number' && c > 40000 && c < 55000) { const d = new Date((c - 25569) * 86400000); const y = d.getFullYear(); if (y >= 2020 && y <= 2035) yearCounts[y] = (yearCounts[y]||0) + 5; }
  }
  const years = Object.keys(yearCounts);
  if (years.length === 0) return null;
  years.sort((a,b) => yearCounts[b] - yearCounts[a] || (+b) - (+a));
  return +years[0];
}

const MONTHS_ES = {ene:0,feb:1,mar:2,abr:3,may:4,jun:5,jul:6,ago:7,sep:8,oct:9,nov:10,dic:11,enero:0,febrero:1,marzo:2,abril:3,mayo:4,junio:5,julio:6,agosto:7,septiembre:8,octubre:9,noviembre:10,diciembre:11};

function parseDate(v, yearHint) {
  if (!v) return null;
  if (v instanceof Date && !isNaN(v)) { const d = new Date(v.getFullYear(), v.getMonth(), v.getDate()); return isNaN(d) ? null : d; }
  if (typeof v === 'number') { if (v > 40000 && v < 55000) { const utc = new Date((v - 25569) * 86400000); return new Date(utc.getUTCFullYear(), utc.getUTCMonth(), utc.getUTCDate()); } return null; }
  let s = String(v).trim();
  s = s.replace(/\s+\d{1,2}:\d{2}(:\d{2})?.*$/, '');
  let d, m, y, match;
  match = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (match) { d=+match[1]; m=+match[2]; y=+match[3]; return new Date(y, m-1, d); }
  match = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (match) { y=+match[1]; m=+match[2]; d=+match[3]; return new Date(y, m-1, d); }
  match = s.match(/^(\d{1,2})[\/\-](\d{1,2})$/);
  if (match) { d=+match[1]; m=+match[2]; return new Date(yearHint||2026, m-1, d); }
  match = s.toLowerCase().match(/(\d{1,2})\s+de\s+(\w+)(?:\s+(?:de\s+)?(\d{4}))?/);
  if (match && MONTHS_ES[match[2]] !== undefined) { d=+match[1]; m=MONTHS_ES[match[2]]; y=match[3]?+match[3]:yearHint; return new Date(y, m, d); }
  match = s.toLowerCase().match(/(\w{3,})\s+(\d{1,2})/);
  if (match && MONTHS_ES[match[1]] !== undefined) return new Date(yearHint, MONTHS_ES[match[1]], +match[2]);
  match = s.toLowerCase().match(/(\d{1,2})\s+(\w{3,})/);
  if (match && MONTHS_ES[match[2]] !== undefined) return new Date(yearHint, MONTHS_ES[match[2]], +match[1]);
  return null;
}

/* ‚îÄ‚îÄ 5. COLUMN AUTO-DETECTION ‚îÄ‚îÄ */
const BLACKLIST = /saldo|identificaci|nit|codigo|cuenta|secuencia|centro|sucursal|consecutivo|c[o√≥]digo/i;

function detectColumns(headers, dataRows, isExtracto) {
  const h = headers.map(x => norm(x));
  const map = {fecha:-1, desc:-1, ref:-1, debito:-1, credito:-1, valor:-1, tercero:-1};
  const rules = [
    ['fecha',   ['fecha','date','fec','fch']],
    ['desc',    ['descripcion','detalle','concepto','observacion','movimiento']],
    ['ref',     ['referencia','dcto','dcto.','comprobante','nro','cheque','transaccion']],
    ['debito',  ['debito','cargo','retiro','salida','egreso']],
    ['credito', ['credito','abono','deposito','entrada','consignacion']],
    ['valor',   ['valor','monto','importe','amount','vlr']],
    ['tercero', ['nombre tercero','tercero','razon social','beneficiario']],
  ];
  for (const [field, kws] of rules) {
    for (let i = 0; i < h.length; i++) {
      if (Object.values(map).includes(i)) continue;
      if (kws.some(k => h[i].includes(k))) {
        if (['debito','credito','valor'].includes(field) && BLACKLIST.test(headers[i])) continue;
        if (field === 'valor' && h[i].includes('saldo')) continue;
        if (field === 'desc' && (h[i].includes('tercero') || h[i].includes('cuenta'))) continue;
        map[field] = i; break;
      }
    }
  }
  if (isExtracto && map.valor === -1 && map.debito === -1 && map.credito === -1) {
    for (let i = 0; i < headers.length; i++) {
      if (Object.values(map).includes(i)) continue;
      if (BLACKLIST.test(headers[i]) || h[i].includes('saldo')) continue;
      let pos = 0, neg = 0;
      for (let r = 0; r < Math.min(50, dataRows.length); r++) {
        const v = typeof dataRows[r][i] === 'number' ? dataRows[r][i] : toNum(dataRows[r][i], 'auto');
        if (v > 0) pos++; if (v < 0) neg++;
      }
      if (pos >= 3 && neg >= 2) { map.valor = i; break; }
    }
  }
  if (!isExtracto && map.debito === -1 && map.credito === -1 && map.valor === -1) {
    const numCols = [];
    for (let i = 0; i < headers.length; i++) {
      if (Object.values(map).includes(i)) continue;
      if (BLACKLIST.test(headers[i]) || h[i].includes('saldo') || h[i].includes('inicial') || h[i].includes('total')) continue;
      let cnt = 0;
      for (let r = 0; r < Math.min(20, dataRows.length); r++) {
        const v = dataRows[r][i];
        if (typeof v === 'number') cnt++;
        else if (v && !isNaN(Number(String(v).replace(/[,$.\-\s()]/g,'')))) cnt++;
      }
      if (cnt >= 5) numCols.push(i);
    }
    if (numCols.length >= 2) { map.debito = numCols[0]; map.credito = numCols[1]; }
    else if (numCols.length === 1) { map.valor = numCols[0]; }
  }
  if (map.fecha === -1) {
    for (let i = 0; i < headers.length; i++) {
      if (Object.values(map).includes(i)) continue;
      let dc = 0;
      for (let r = 0; r < Math.min(15, dataRows.length); r++) {
        const v = dataRows[r][i];
        if (v instanceof Date) dc++;
        else if (typeof v === 'number' && v > 40000 && v < 55000) dc++;
        else if (typeof v === 'string' && /\d{1,2}[\/\-]\d{1,2}/.test(v)) dc++;
      }
      if (dc >= 5) { map.fecha = i; break; }
    }
  }
  if (map.desc === -1) {
    let best = 0, bestI = -1;
    for (let i = 0; i < headers.length; i++) {
      if (Object.values(map).includes(i)) continue;
      const avg = dataRows.slice(0,20).reduce((s,r) => s + String(r[i]||'').length, 0) / Math.min(20, dataRows.length);
      if (avg > best) { best = avg; bestI = i; }
    }
    if (bestI >= 0) map.desc = bestI;
  }
  return map;
}

function norm(s) { return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }

/* ‚îÄ‚îÄ 6. STEP 2: RENDER FILE CARDS ‚îÄ‚îÄ */
function goStep1() { show('step1'); hide('step2'); hide('step3'); setSI(1); }
function goStep2() {
  for (const k of ['E','A']) {
    const f = F[k];
    const hdr = f.headerRow;
    const headers = f.noHeader ? f.raw[0].map((_,i) => 'Col_' + String.fromCharCode(65+i)) : (f.raw[hdr]||[]).map((h,i) => h ? String(h).trim() : 'Col_'+(i+1));
    const dataStart = f.noHeader ? 0 : hdr + 1;
    const dataRows = cleanRows(f.raw.slice(dataStart));
    f.map = detectColumns(headers, dataRows, k === 'E');
    const valCol = f.map.valor >= 0 ? f.map.valor : (f.map.debito >= 0 ? f.map.debito : -1);
    if (valCol >= 0 && f.numFmt === 'auto') { f.numFmt = detectNumFormat(f.display.slice(dataStart), valCol); }
  }
  renderFileCard('E'); renderFileCard('A');
  hide('step1'); show('step2'); hide('step3'); setSI(2);
}

function renderFileCard(k) {
  const f = F[k];
  const isE = k === 'E';
  const label = isE ? 'üè¶ Extracto Bancario' : 'üìí Libro Auxiliar';
  const rows = f.raw;
  const hdr = f.headerRow;
  const noH = f.noHeader;
  const dataStart = noH ? 0 : hdr + 1;
  const headers = noH ? rows[0].map((_,i) => 'Col_' + String.fromCharCode(65 + (i % 26))) : (rows[hdr]||[]).map((h,i) => h ? String(h).trim() : 'Col_'+(i+1));
  const dataRows = cleanRows(rows.slice(dataStart));
  let html = `<div class="card-title">${label} ‚Äî ${esc(f.name)}</div>`;
  html += `<div class="ctrl-row">
    <div class="ctrl-item"><label>Fila encabezado</label><input type="number" min="1" max="${rows.length}" value="${hdr+1}" onchange="changeHeader('${k}',+this.value-1)" id="hdrIn${k}" ${noH?'disabled':''}></div>
    <div class="ctrl-item" style="flex-direction:row;align-items:center;gap:6px;align-self:end"><input type="checkbox" ${noH?'checked':''} onchange="toggleNoHeader('${k}',this.checked)"><label style="text-transform:none;cursor:pointer">Sin encabezado</label></div>
    <div class="ctrl-item"><label>Formato num√©rico</label><select onchange="changeNumFmt('${k}',this.value)" id="fmtSel${k}">
      <option value="auto" ${f.numFmt==='auto'?'selected':''}>Auto-detectar</option>
      <option value="plain" ${f.numFmt==='plain'?'selected':''}>Sin separador (1234.56)</option>
      <option value="us" ${f.numFmt==='us'?'selected':''}>Americano (1,234.56)</option>
      <option value="col" ${f.numFmt==='col'?'selected':''}>Colombiano (1.234,56)</option>
    </select></div>
  </div>`;
  const valMode = f.map.valor >= 0 ? 'valor √∫nico con signo' : (f.map.debito >= 0 ? 'd√©bito/cr√©dito separados' : '‚ö† no se detectaron columnas de valor');
  html += `<div class="card-info">${dataRows.length} movimientos ¬∑ ${valMode} ¬∑ formato: ${f.numFmt}</div>`;
  const showN = Math.min(rows.length, 25);
  html += `<div class="raw-preview"><table><tr><th style="width:30px">#</th>`;
  const maxCols = Math.max(...rows.slice(0, showN).map(r => r.length));
  for (let c = 0; c < Math.min(maxCols, 12); c++) html += `<th>Col ${c+1}</th>`;
  html += '</tr>';
  for (let i = 0; i < showN; i++) {
    const cls = (i === hdr && !noH) ? 'rHead' : (i < dataStart ? 'rSkip' : 'rData');
    html += `<tr class="${cls}"><td class="rn">${i+1}</td>`;
    for (let c = 0; c < Math.min(maxCols, 12); c++) {
      let v = f.display[i] ? f.display[i][c] : '';
      if (v instanceof Date) v = v.toLocaleDateString('es-CO');
      html += `<td title="${esc(String(v||''))}">${esc(String(v||'').substring(0,30))}</td>`;
    }
    html += '</tr>';
  }
  if (rows.length > showN) html += `<tr class="rSkip"><td class="rn">‚Ä¶</td><td colspan="${Math.min(maxCols,12)}">‚Ä¶ ${rows.length - showN} filas m√°s</td></tr>`;
  html += '</table></div>';
  html += '<div style="font-size:.68rem;color:var(--f400);margin-bottom:8px">üîµ = encabezado ¬∑ ‚¨ú = datos ¬∑ üîò = ignorado</div>';
  const fields = isE
    ? [{k:'fecha',l:'üìÖ Fecha'},{k:'desc',l:'üìù Descripci√≥n'},{k:'ref',l:'üî¢ Ref/Dcto'},{k:'valor',l:'üí∞ Valor (¬±signo)'},{k:'debito',l:'‚ûñ D√©bito'},{k:'credito',l:'‚ûï Cr√©dito'}]
    : [{k:'fecha',l:'üìÖ Fecha'},{k:'desc',l:'üìù Descripci√≥n'},{k:'ref',l:'üî¢ Comprobante'},{k:'tercero',l:'üë§ Tercero'},{k:'debito',l:'‚ûñ D√©bito'},{k:'credito',l:'‚ûï Cr√©dito'},{k:'valor',l:'üí∞ Valor √∫nico'}];
  html += '<div class="col-map">';
  for (const fld of fields) {
    const opts = headers.map((h,i) => `<option value="${i}" ${f.map[fld.k]===i?'selected':''}>${esc(h)}</option>`).join('');
    html += `<div class="map-item"><label>${fld.l}</label><select class="${f.map[fld.k]>=0?'mapped':''}" onchange="changeMap('${k}','${fld.k}',+this.value);this.className=this.value>=0?'mapped':''"><option value="-1">‚Äî No aplica ‚Äî</option>${opts}</select></div>`;
  }
  html += '</div>';
  const ownYear = f.map.fecha >= 0 ? guessYearFromTransactions(rows, f.map.fecha, dataStart) : null;
  const otherK = k === 'E' ? 'A' : 'E';
  const otherYear = F[otherK].raw ? getTransactionYear(otherK) : null;
  const yearHint = ownYear || otherYear || new Date().getFullYear();
  html += '<div style="font-size:.78rem;font-weight:700;color:var(--f600);margin:12px 0 4px">Vista previa interpretada (verifica que los valores se lean bien):</div>';
  html += '<div class="parsed-preview"><table><tr><th>Fecha</th><th>Descripci√≥n</th>';
  if (!isE) html += '<th>Tercero</th>';
  html += '<th>Ref</th>';
  if (f.map.valor >= 0) html += '<th>Valor</th>';
  else { html += '<th>D√©bito</th><th>Cr√©dito</th>'; }
  html += '</tr>';
  const previewRows = dataRows.slice(0, 5);
  for (const r of previewRows) {
    const fecha = f.map.fecha >= 0 ? parseDate(r[f.map.fecha], yearHint) : null;
    const desc = f.map.desc >= 0 ? String(r[f.map.desc]||'') : '';
    const ref = f.map.ref >= 0 ? String(r[f.map.ref]||'') : '';
    const tercero = f.map.tercero >= 0 ? String(r[f.map.tercero]||'') : '';
    let valHtml = '';
    if (f.map.valor >= 0) {
      const raw = r[f.map.valor];
      const parsed = toNum(raw, f.numFmt);
      const cls = parsed === 0 && raw !== 0 && raw !== '' && raw != null ? 'warn' : 'ok';
      valHtml = `<td class="num ${cls}" title="Original: ${esc(String(raw))}">${fmtN(parsed)}</td>`;
    } else {
      const rawD = f.map.debito >= 0 ? r[f.map.debito] : '';
      const rawC = f.map.credito >= 0 ? r[f.map.credito] : '';
      const pD = toNum(rawD, f.numFmt), pC = toNum(rawC, f.numFmt);
      valHtml = `<td class="num" title="Original: ${esc(String(rawD))}">${fmtN(pD)}</td><td class="num" title="Original: ${esc(String(rawC))}">${fmtN(pC)}</td>`;
    }
    html += `<tr><td class="${fecha?'ok':'warn'}">${fecha ? fecha.toLocaleDateString('es-CO',{day:'2-digit',month:'short',year:'numeric'}) : '‚ö† ?'}</td>`;
    html += `<td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(desc.substring(0,40))}</td>`;
    if (!isE) html += `<td>${esc(tercero.substring(0,25))}</td>`;
    html += `<td>${esc(ref.substring(0,20))}</td>${valHtml}</tr>`;
  }
  html += '</table></div>';
  if (previewRows.length === 0) html += '<div class="card-info" style="border-left-color:var(--amber)">‚ö† No se encontraron filas de datos. Verifica la fila del encabezado.</div>';
  document.getElementById('card'+k).innerHTML = html;
}

function changeHeader(k, row) { F[k].headerRow = Math.max(0, Math.min(row, F[k].raw.length - 2)); refreshDetection(k); }
function toggleNoHeader(k, val) { F[k].noHeader = val; const inp = document.getElementById('hdrIn'+k); if (inp) inp.disabled = val; refreshDetection(k); }
function changeNumFmt(k, fmt) { F[k].numFmt = fmt; renderFileCard(k); }
function changeMap(k, field, val) { F[k].map[field] = val; renderFileCard(k); }
function refreshDetection(k) {
  const f = F[k];
  const hdr = f.noHeader ? 0 : f.headerRow;
  const headers = f.noHeader ? f.raw[0].map((_,i) => 'Col_' + String.fromCharCode(65+i)) : (f.raw[hdr]||[]).map((h,i) => h ? String(h).trim() : 'Col_'+(i+1));
  const dataStart = f.noHeader ? 0 : hdr + 1;
  const dataRows = cleanRows(f.raw.slice(dataStart));
  f.map = detectColumns(headers, dataRows, k === 'E');
  const valCol = f.map.valor >= 0 ? f.map.valor : (f.map.debito >= 0 ? f.map.debito : -1);
  if (valCol >= 0) f.numFmt = detectNumFormat(f.display.slice(dataStart), valCol);
  renderFileCard(k);
}

function cleanRows(rows) {
  return rows.filter(r => {
    if (!r || r.every(c => c == null || c === '')) return false;
    const fc = norm(String(r[0]||''));
    if (fc.startsWith('total') || fc.includes('fin estado') || fc.includes('procesado en') || fc.startsWith('saldo anterior') || fc.startsWith('subtotal') || fc.includes('resumen')) return false;
    return true;
  });
}

/* ‚îÄ‚îÄ 7. MATCHING ALGORITHM ‚îÄ‚îÄ */
function ejecutar() {
  const tol = +(document.getElementById('optTol').value || 1);
  const yearE = getTransactionYear('E');
  const yearA = getTransactionYear('A');
  const finalYearE = yearE || yearA || new Date().getFullYear();
  const finalYearA = yearA || yearE || new Date().getFullYear();
  console.log('DEBUG yearE=', yearE, 'yearA=', yearA, 'finalE=', finalYearE, 'finalA=', finalYearA);
  console.log('DEBUG E map=', JSON.stringify(F.E.map), 'numFmt=', F.E.numFmt, 'hdr=', F.E.headerRow);
  console.log('DEBUG A map=', JSON.stringify(F.A.map), 'numFmt=', F.A.numFmt, 'hdr=', F.A.headerRow);
  const ext = buildRecords('E', finalYearE);
  const aux = buildRecords('A', finalYearA);
  if (ext.length === 0) { alert('No se encontraron movimientos en el extracto.'); return; }
  if (aux.length === 0) { alert('No se encontraron movimientos en el auxiliar.'); return; }
  console.log('DEBUG ext[0]=', JSON.stringify(ext[0], (k,v) => v instanceof Date ? v.toISOString() : v));
  console.log('DEBUG ext[1]=', JSON.stringify(ext[1], (k,v) => v instanceof Date ? v.toISOString() : v));
  console.log('DEBUG aux[0]=', JSON.stringify(aux[0], (k,v) => v instanceof Date ? v.toISOString() : v));
  console.log('DEBUG aux[1]=', JSON.stringify(aux[1], (k,v) => v instanceof Date ? v.toISOString() : v));
  // Debug: test one specific match manually
  let dbgMatchCount = 0;
  for (let di = 0; di < Math.min(5, ext.length); di++) {
    for (let dj = 0; dj < Math.min(5, aux.length); dj++) {
      const am = amtMatch(ext[di], aux[dj], tol, true);
      const dc = dateClose(ext[di].fecha, aux[dj].fecha, 0);
      if (am || (ext[di].deb > 0 && aux[dj].deb > 0 && Math.abs(ext[di].deb - aux[dj].deb) < 100)) {
        console.log(`DEBUG match test E[${di}] vs A[${dj}]: amt=${am} date=${dc}`,
          `E.deb=${ext[di].deb} E.cre=${ext[di].cre} E.fecha=${ext[di].fecha}`,
          `A.deb=${aux[dj].deb} A.cre=${aux[dj].cre} A.fecha=${aux[dj].fecha}`);
        dbgMatchCount++;
      }
    }
  }
  console.log('DEBUG manual match checks found:', dbgMatchCount);
  const matched = [];
  const uE = new Set(), uA = new Set();
  doPass(ext, aux, uE, uA, matched, tol, 0, true, 'alta', 'Monto, fecha y tipo exactos');
  console.log('DEBUG after pass1 (exact):', matched.length, 'matches');
  doPass(ext, aux, uE, uA, matched, tol, 2, true, 'alta', 'Monto y tipo, fecha ¬±2 d√≠as');
  console.log('DEBUG after pass2 (¬±2d):', matched.length, 'matches');
  doPass(ext, aux, uE, uA, matched, tol, 5, true, 'media', 'Monto y tipo, fecha ¬±5 d√≠as');
  doPassRef(ext, aux, uE, uA, matched, tol, 'media', 'Monto y referencia');
  doPass(ext, aux, uE, uA, matched, tol, 15, true, 'baja', 'Monto y tipo, ¬±15 d√≠as');
  doPass(ext, aux, uE, uA, matched, tol, 31, false, 'baja', 'Solo monto (¬±31 d√≠as)');
  console.log('DEBUG TOTAL matches:', matched.length);
  const soloE = ext.filter((_,i) => !uE.has(i));
  const soloA = aux.filter((_,i) => !uA.has(i));
  const sE = {d: sum(ext,'deb'), c: sum(ext,'cre')};
  const sA = {d: sum(aux,'deb'), c: sum(aux,'cre')};
  const ssE = {d: sum(soloE,'deb'), c: sum(soloE,'cre')};
  const ssA = {d: sum(soloA,'deb'), c: sum(soloA,'cre')};
  resultados = {matched, soloE, soloA, ext, aux, sE, sA, ssE, ssA, tol};
  renderResults();
  hide('step2'); show('step3'); setSI(3);
}

function getTransactionYear(k) {
  const f = F[k];
  if (!f.raw || f.map.fecha < 0) return null;
  const dataStart = f.noHeader ? 0 : f.headerRow + 1;
  return guessYearFromTransactions(f.raw, f.map.fecha, dataStart);
}

function buildRecords(k, yearHint) {
  const f = F[k];
  const hdr = f.noHeader ? 0 : f.headerRow;
  const dataStart = f.noHeader ? 0 : hdr + 1;
  const dataRows = cleanRows(f.raw.slice(dataStart));
  const fmt = f.numFmt;
  const recs = [];
  for (const r of dataRows) {
    const fecha = f.map.fecha >= 0 ? parseDate(r[f.map.fecha], yearHint) : null;
    const desc = f.map.desc >= 0 ? String(r[f.map.desc]||'').trim() : '';
    const ref = f.map.ref >= 0 ? String(r[f.map.ref]||'').trim() : '';
    const tercero = f.map.tercero >= 0 ? String(r[f.map.tercero]||'').trim() : '';
    let deb = 0, cre = 0;
    if (f.map.valor >= 0 && f.map.debito < 0 && f.map.credito < 0) {
      const v = toNum(r[f.map.valor], fmt);
      if (v > 0) deb = v; else if (v < 0) cre = Math.abs(v);
    } else {
      deb = f.map.debito >= 0 ? Math.abs(toNum(r[f.map.debito], fmt)) : 0;
      cre = f.map.credito >= 0 ? Math.abs(toNum(r[f.map.credito], fmt)) : 0;
    }
    if (deb === 0 && cre === 0) continue;
    recs.push({fecha, desc, ref, tercero, deb, cre});
  }
  return recs;
}

function doPass(ext, aux, uE, uA, matched, tol, dayTol, chkSign, conf, reason) {
  for (let i = 0; i < ext.length; i++) {
    if (uE.has(i)) continue;
    for (let j = 0; j < aux.length; j++) {
      if (uA.has(j)) continue;
      if (!amtMatch(ext[i], aux[j], tol, chkSign)) continue;
      if (!dateClose(ext[i].fecha, aux[j].fecha, dayTol)) continue;
      matched.push({ei:i, ai:j, conf, reason});
      uE.add(i); uA.add(j); break;
    }
  }
}

function doPassRef(ext, aux, uE, uA, matched, tol, conf, reason) {
  for (let i = 0; i < ext.length; i++) {
    if (uE.has(i)) continue;
    for (let j = 0; j < aux.length; j++) {
      if (uA.has(j)) continue;
      if (!amtMatch(ext[i], aux[j], tol, true)) continue;
      if (!refMatch(ext[i], aux[j])) continue;
      matched.push({ei:i, ai:j, conf, reason});
      uE.add(i); uA.add(j); break;
    }
  }
}

function amtMatch(e, a, tol, chkSign) {
  if (chkSign) {
    if (e.deb > 0 && a.deb > 0) return Math.abs(Math.round(e.deb*100) - Math.round(a.deb*100)) <= tol*100;
    if (e.cre > 0 && a.cre > 0) return Math.abs(Math.round(e.cre*100) - Math.round(a.cre*100)) <= tol*100;
    return false;
  }
  const ve = e.deb||e.cre, va = a.deb||a.cre;
  return Math.abs(Math.round(ve*100) - Math.round(va*100)) <= tol*100;
}

function dateClose(d1, d2, tol) {
  if (!d1 || !d2) return tol >= 15;
  const t1 = Date.UTC(d1.getFullYear(), d1.getMonth(), d1.getDate());
  const t2 = Date.UTC(d2.getFullYear(), d2.getMonth(), d2.getDate());
  return Math.abs(t1 - t2) / 864e5 <= tol;
}

function refMatch(e, a) {
  const ne = (e.ref + ' ' + e.desc).match(/\d{4,}/g) || [];
  const na = (a.ref + ' ' + a.desc).match(/\d{4,}/g) || [];
  for (const n of ne) if (na.some(m => m.includes(n) || n.includes(m))) return true;
  return false;
}

function sum(arr, field) { return arr.reduce((s, r) => s + (r[field]||0), 0); }

/* ‚îÄ‚îÄ 8. CATEGORIZATION ‚îÄ‚îÄ */
const CATEGORIES = [
  {id:'gmf',name:'GMF / 4√ó1000',icon:'üèõÔ∏è',color:'#DC2626',bg:'#FEF2F2',test:d=>d.includes('4x1000')||d.includes('impto gobierno')||d.includes('gmf')||d.includes('4 x 1000')||d.includes('gravamen')},
  {id:'interes',name:'Intereses recibidos',icon:'üìà',color:'#059669',bg:'#ECFDF5',test:d=>(d.includes('interes')||d.includes('inter√©s'))&&(d.includes('ahorro')||d.includes('bancario')||d.includes('cdt')||d.includes('rendimiento'))},
  {id:'comision',name:'Comisiones bancarias',icon:'üè¶',color:'#D97706',bg:'#FFFBEB',test:d=>d.includes('comision')||d.includes('comisi√≥n')||d.includes('cobro servicio')},
  {id:'cuota',name:'Cuota de manejo',icon:'üí≥',color:'#9333EA',bg:'#F5F3FF',test:d=>d.includes('cuota manejo')||d.includes('cuota de manejo')||d.includes('cobro cuota')},
  {id:'retefte',name:'Retenci√≥n en la fuente',icon:'üìã',color:'#BE185D',bg:'#FDF2F8',test:d=>d.includes('retefuente')||d.includes('retefte')||(d.includes('retencion')&&d.includes('fuente'))||(d.includes('retenci√≥n')&&d.includes('fuente'))},
  {id:'reteiva',name:'Retenci√≥n de IVA',icon:'üìë',color:'#0369A1',bg:'#F0F9FF',test:d=>(d.includes('retencion')||d.includes('retenci√≥n'))&&(d.includes('iva')||d.includes('i.v.a'))},
  {id:'reteica',name:'Retenci√≥n de ICA',icon:'üè¢',color:'#4338CA',bg:'#EEF2FF',test:d=>(d.includes('retencion')||d.includes('retenci√≥n'))&&d.includes('ica')},
  {id:'plataforma',name:'Plataformas digitales',icon:'üì±',color:'#0891B2',bg:'#ECFEFF',test:d=>d.includes('bold')||d.includes('nequi')||d.includes('daviplata')||d.includes('pse')||d.includes('rappipay')||d.includes('wompi')},
  {id:'cheque',name:'Cheques',icon:'üìù',color:'#64748B',bg:'#F8FAFC',test:d=>d.includes('cheque')||d.includes('chq')},
  {id:'otro',name:'Otros sin clasificar',icon:'‚ùì',color:'#6B7280',bg:'#F9FAFB',test:()=>true},
];

function categorize(items) {
  const cats = {};
  CATEGORIES.forEach(c => cats[c.id] = {def:c, items:[], totalDeb:0, totalCre:0});
  for (const item of items) {
    const d = (item.desc||'').toLowerCase();
    for (const c of CATEGORIES) {
      if (c.test(d)) { cats[c.id].items.push(item); cats[c.id].totalDeb += item.deb || 0; cats[c.id].totalCre += item.cre || 0; break; }
    }
  }
  return cats;
}

function guessCausa(desc) {
  const d = (desc||'').toLowerCase();
  for (const c of CATEGORIES) { if (c.id !== 'otro' && c.test(d)) return c.name; }
  return 'Pendiente de clasificar';
}

/* ‚îÄ‚îÄ 9. RENDER RESULTS ‚îÄ‚îÄ */
function renderResults() {
  const {matched, soloE, soloA, ext, aux, sE, sA, ssE, ssA, tol} = resultados;
  const total = Math.max(ext.length, aux.length);
  const needsPay = total > FREE_LIMIT;
  const lim = needsPay ? FREE_LIMIT : 999999;
  const pctConc = ext.length > 0 ? Math.round(matched.length / Math.max(ext.length, aux.length) * 100) : 0;
  document.getElementById('sumCards').innerHTML =
    sc('sc-green', matched.length, 'Conciliadas') +
    sc('sc-blue', soloE.length, 'Solo extracto') +
    sc('sc-amber', soloA.length, 'Solo auxiliar') +
    `<div class="summary-card" style="border-color:${pctConc>=90?'var(--g400)':pctConc>=70?'var(--amber)':'var(--red)'}"><div class="sc-val" style="color:${pctConc>=90?'var(--g600)':pctConc>=70?'var(--amber)':'var(--red)'}">${pctConc}%</div><div class="sc-label">Conciliaci√≥n</div></div>`;
  const saldoE = sE.d - sE.c;
  const saldoA = sA.d - sA.c;
  let bh = '<div class="bridge"><h3>üîó Puente de Conciliaci√≥n</h3>';
  bh += br('br-start', 'Saldo neto seg√∫n extracto bancario', fmtS(saldoE));
  bh += br('br-sep', 'Partidas registradas en extracto, NO en libros', '');
  if (ssE.d > 0) bh += br('br-add', '(+) D√©bitos en extracto no registrados en libros', '+ ' + fmtS(ssE.d));
  if (ssE.c > 0) bh += br('br-sub', '(‚àí) Cr√©ditos en extracto no registrados en libros', '‚àí ' + fmtS(ssE.c));
  bh += br('br-sep', 'Partidas registradas en libros, NO en extracto', '');
  if (ssA.d > 0) bh += br('br-sub', '(‚àí) D√©bitos en libros no reflejados en extracto', '‚àí ' + fmtS(ssA.d));
  if (ssA.c > 0) bh += br('br-add', '(+) Cr√©ditos en libros no reflejados en extracto', '+ ' + fmtS(ssA.c));
  bh += br('br-end', 'Saldo neto seg√∫n libro auxiliar', fmtS(saldoA));
  const checkVal = saldoE + ssE.d - ssE.c - ssA.d + ssA.c;
  const checkOk = Math.abs(checkVal - saldoA) < 2;
  bh += `<div class="bridge-check ${checkOk ? 'ok' : 'diff'}">${checkOk ? '‚úì El puente cuadra correctamente' : '‚ö† Diferencia de $ ' + fmtN(Math.abs(checkVal - saldoA)) + ' ‚Äî revise partidas pendientes'}</div>`;
  bh += '</div>';
  document.getElementById('reconBox').innerHTML = bh;
  const catsE = categorize(soloE);
  const catsA = categorize(soloA);
  let ah = '<div class="analysis-grid">';
  ah += '<div class="analysis-card"><h3>üè¶ Partidas solo en extracto</h3>';
  ah += renderCatList(catsE, soloE);
  ah += '</div>';
  ah += '<div class="analysis-card"><h3>üìí Partidas solo en libros</h3>';
  ah += renderCatList(catsA, soloA);
  ah += '</div>';
  ah += '</div>';
  const bankCharges = [{id:'gmf',label:'GMF / 4√ó1000'},{id:'comision',label:'Comisiones bancarias'},{id:'cuota',label:'Cuota de manejo'},{id:'retefte',label:'Retenci√≥n en la fuente'},{id:'reteiva',label:'Retenci√≥n de IVA'},{id:'reteica',label:'Retenci√≥n de ICA'}];
  const hasCharges = bankCharges.some(bc => catsE[bc.id] && catsE[bc.id].items.length > 0);
  const interestItems = catsE.interes ? catsE.interes.items : [];
  if (hasCharges || interestItems.length > 0) {
    ah += '<div class="analysis-card" style="grid-column:1/-1"><h3>üí∞ Resumen contable ‚Äî Movimientos bancarios pendientes de registro</h3>';
    ah += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">';
    if (hasCharges) {
      ah += '<div><div style="font-size:.78rem;font-weight:700;color:var(--red);margin-bottom:8px">Gastos bancarios por registrar</div><ul class="cat-list">';
      let totalGastos = 0;
      for (const bc of bankCharges) { const cat = catsE[bc.id]; if (!cat || cat.items.length === 0) continue; const val = cat.totalCre; totalGastos += val; ah += `<li class="cat-item"><div class="cat-left"><div class="cat-icon" style="background:${cat.def.bg}">${cat.def.icon}</div><div><div class="cat-name">${bc.label}</div><div class="cat-count">${cat.items.length} movimiento${cat.items.length>1?'s':''}</div></div></div><div class="cat-val val-red">$ ${fmtN(val)}</div></li>`; }
      ah += `</ul><div class="cat-total"><span>Total gastos bancarios</span><span class="cat-val val-red">$ ${fmtN(totalGastos)}</span></div></div>`;
    }
    ah += '<div><div style="font-size:.78rem;font-weight:700;color:var(--g600);margin-bottom:8px">Ingresos bancarios por registrar</div><ul class="cat-list">';
    if (interestItems.length > 0) {
      const intTotal = catsE.interes.totalDeb;
      ah += `<li class="cat-item"><div class="cat-left"><div class="cat-icon" style="background:${catsE.interes.def.bg}">${catsE.interes.def.icon}</div><div><div class="cat-name">Intereses recibidos</div><div class="cat-count">${interestItems.length} movimiento${interestItems.length>1?'s':''}</div></div></div><div class="cat-val val-green">$ ${fmtN(intTotal)}</div></li>`;
      ah += `</ul><div class="cat-total"><span>Total ingresos bancarios</span><span class="cat-val val-green">$ ${fmtN(intTotal)}</span></div>`;
    } else {
      ah += '<li class="cat-item" style="color:var(--f400)">No se detectaron ingresos bancarios pendientes</li></ul>';
    }
    ah += '</div></div></div>';
  }
  resultados.catsE = catsE;
  resultados.catsA = catsA;
  document.getElementById('analysisBox').innerHTML = ah;
  const tabs = [{id:'conc',l:'‚úì Conciliadas',n:matched.length},{id:'ext',l:'üè¶ Solo Extracto',n:soloE.length},{id:'aux',l:'üìí Solo Auxiliar',n:soloA.length}];
  document.getElementById('rTabs').innerHTML = tabs.map((t,i) => `<button class="results-tab ${i===0?'active':''}" onclick="swTab('${t.id}',this)">${t.l}<span class="tab-count">${t.n}</span></button>`).join('');
  let p = '';
  p += '<div class="results-panel active" id="panel-conc"><div class="results-scroll"><table class="rtable"><tr><th>#</th><th>Fecha Ext</th><th>Desc Extracto</th><th>Tipo</th><th>Valor Ext</th><th>Fecha Aux</th><th>Tercero/Desc Aux</th><th>Valor Aux</th>';
  if (tol > 0) p += '<th>Dif</th>';
  p += '<th>Conf</th></tr>';
  matched.slice(0,lim).forEach((m,idx) => {
    const e = ext[m.ei], a = aux[m.ai];
    const tipo = e.deb > 0 ? 'Entrada' : 'Salida';
    const tc = e.deb > 0 ? 'tipo-in' : 'tipo-out';
    const ve = e.deb || e.cre, va = a.deb || a.cre;
    const diff = Math.abs(ve - va);
    const cl = 'conf-'+m.conf, lb = m.conf==='alta'?'‚úì Alta':m.conf==='media'?'~ Media':'? Baja';
    const ad = a.tercero || a.desc;
    p += `<tr><td>${idx+1}</td><td>${fD(e.fecha)}</td><td class="desc-cell" title="${esc(e.desc)}">${esc(e.desc)}</td><td class="${tc}">${tipo}</td><td class="num">${fmtN(ve)}</td><td>${fD(a.fecha)}</td><td class="desc-cell" title="${esc(ad)}">${esc(ad)}</td><td class="num">${fmtN(va)}</td>`;
    if (tol > 0) p += `<td class="num" style="color:${diff>0?'var(--amber)':'var(--f300)'}">${diff > 0 ? fmtN(diff) : '‚Äî'}</td>`;
    p += `<td><span class="conf ${cl}" title="${m.reason}">${lb}</span></td></tr>`;
  });
  p += '</table></div></div>';
  p += '<div class="results-panel" id="panel-ext"><div class="results-scroll"><table class="rtable"><tr><th>#</th><th>Fecha</th><th>Descripci√≥n</th><th>Tipo</th><th>Valor</th><th>Categor√≠a</th></tr>';
  soloE.slice(0,lim).forEach((e,i) => {
    const tipo = e.deb > 0 ? 'Entrada' : 'Salida';
    const tc = e.deb > 0 ? 'tipo-in' : 'tipo-out';
    const cat = guessCausa(e.desc);
    p += `<tr><td>${i+1}</td><td>${fD(e.fecha)}</td><td class="desc-cell" title="${esc(e.desc)}">${esc(e.desc)}</td><td class="${tc}">${tipo}</td><td class="num">${fmtN(e.deb||e.cre)}</td><td style="font-size:.7rem;color:var(--f500)">${cat}</td></tr>`;
  });
  p += '</table></div></div>';
  p += '<div class="results-panel" id="panel-aux"><div class="results-scroll"><table class="rtable"><tr><th>#</th><th>Fecha</th><th>Tercero</th><th>Descripci√≥n</th><th>Ref</th><th>Tipo</th><th>Valor</th></tr>';
  soloA.slice(0,lim).forEach((a,i) => {
    const tipo = a.deb > 0 ? 'D√©bito' : 'Cr√©dito';
    const tc = a.deb > 0 ? 'tipo-in' : 'tipo-out';
    p += `<tr><td>${i+1}</td><td>${fD(a.fecha)}</td><td class="desc-cell" title="${esc(a.tercero)}">${esc(a.tercero)}</td><td class="desc-cell" title="${esc(a.desc)}">${esc(a.desc)}</td><td>${esc(a.ref)}</td><td class="${tc}">${tipo}</td><td class="num">${fmtN(a.deb||a.cre)}</td></tr>`;
  });
  p += '</table></div></div>';
  document.getElementById('rPanels').innerHTML = p;
  if (needsPay) {
    document.getElementById('payZone').innerHTML = `<div class="paywall"><h3>üîí Tu archivo tiene ${total} filas (gratis: ${FREE_LIMIT})</h3><p>Se muestran ${FREE_LIMIT} partidas. Para todo + Excel:</p><div class="pricing-mini">${PRICING.filter(p=>p.price>0).map(pr=>`<div class="pm-opt ${total<=pr.max?'selected':''}"><div class="pm-rows">Hasta ${pr.max}</div><div class="pm-price">${pr.label}</div><div class="pm-unit">COP</div></div>`).join('')}</div><button class="btn btn-primary" onclick="alert('Integraci√≥n Wompi pr√≥ximamente.')">Desbloquear</button></div>`;
    document.getElementById('btnXls').style.display = 'none';
  } else {
    document.getElementById('payZone').innerHTML = '';
    document.getElementById('btnXls').style.display = '';
  }
}

function renderCatList(cats, all) {
  let h = '<ul class="cat-list">';
  let totalNet = 0;
  for (const c of CATEGORIES) {
    const cat = cats[c.id];
    if (!cat || cat.items.length === 0) continue;
    const net = cat.totalDeb - cat.totalCre;
    totalNet += cat.totalDeb + cat.totalCre;
    const valClass = net > 0 ? 'val-green' : net < 0 ? 'val-red' : '';
    h += `<li class="cat-item"><div class="cat-left"><div class="cat-icon" style="background:${c.bg}">${c.icon}</div><div><div class="cat-name">${c.name}</div><div class="cat-count">${cat.items.length} ¬∑ D√©b $${fmtN(cat.totalDeb)} ¬∑ Cr√© $${fmtN(cat.totalCre)}</div></div></div><div class="cat-val ${valClass}">$ ${fmtN(cat.totalDeb + cat.totalCre)}</div></li>`;
  }
  h += '</ul>';
  h += `<div class="cat-total"><span>Total ${all.length} partidas</span><span>$ ${fmtN(totalNet)}</span></div>`;
  return h;
}

function br(cls, label, val) { return `<div class="bridge-row ${cls}"><span class="br-label">${label}</span><span class="br-val">${val}</span></div>`; }
function fmtS(n) { return (n < 0 ? '‚àí' : '') + '$ ' + fmtN(Math.abs(n)); }

/* ‚îÄ‚îÄ 10. EXPORT EXCEL ‚îÄ‚îÄ */
function extractMeta(k) {
  const f = F[k];
  if (!f.raw) return {};
  const meta = {}, hdr = f.noHeader ? 0 : f.headerRow;
  for (let i = 0; i < hdr; i++) {
    const row = f.raw[i]; if (!row) continue;
    for (let j = 0; j < row.length; j++) {
      const v = String(row[j]||'').trim(); if (!v) continue;
      const vl = v.toLowerCase();
      if (!meta.empresa && v.length > 8 && !/desde|hasta|tipo|cuenta|nro|sucursal|informaci|movimiento|auxiliar/i.test(v) && /[A-Z]/.test(v) && !/^\d/.test(v) && i < 5) meta.empresa = v;
      const nit = v.match(/(\d{3,}[\.\d]*\s*-\s*\d)/);
      if (nit && !meta.nit) meta.nit = nit[0].replace(/\./g,'');
      if (/^\d{8,}$/.test(v) && !meta.cuenta) meta.cuenta = v;
    }
  }
  return meta;
}

function tipoProbable(desc, isDeb) {
  const d = (desc||'').toLowerCase();
  if (d.includes('bold')||d.includes('datafono')) return 'Dat√°fono/Tarjeta Cr√©dito';
  if (d.includes('pse')) return isDeb?'Pago PSE recibido':'Pago PSE';
  if (d.includes('nequi')) return 'Transferencia Nequi';
  if (d.includes('daviplata')) return 'Transferencia Daviplata';
  if (d.includes('consignacion')) return 'Consignaci√≥n';
  if (d.includes('transferencia')) return isDeb?'Transferencia recibida':'Transferencia salida';
  if (d.includes('interes')) return 'Intereses bancarios';
  if (d.includes('4x1000')||d.includes('gmf')||d.includes('impto gobierno')) return 'Impuesto GMF';
  if (d.includes('comision')) return 'Comisi√≥n bancaria';
  if (d.includes('cuota manejo')) return 'Cuota de manejo';
  if (d.includes('retencion')||d.includes('retefuente')) return 'Retenci√≥n';
  if (d.includes('cheque')) return 'Cheque';
  return isDeb?'Ingreso por identificar':'Egreso por identificar';
}

function accionSugerida(desc, isDeb) {
  const d = (desc||'').toLowerCase();
  if (d.includes('bold')||d.includes('datafono')||d.includes('interbanc bold')) return isDeb?'Registrar ingreso por ventas TC':'Verificar cobro dat√°fono';
  if (d.includes('nequi')||d.includes('daviplata')) return isDeb?'Registrar ingreso por transferencia':'Verificar pago plataforma';
  if (d.includes('pse')) return isDeb?'Identificar origen y registrar RC':'Identificar proveedor y registrar RP';
  if (d.includes('consignacion')) return 'Identificar origen y registrar RC';
  if (d.includes('transferencia')) return isDeb?'Identificar origen y registrar RC':'Identificar beneficiario y registrar RP';
  if (d.includes('interes')) return 'Registrar ingreso por intereses bancarios';
  if (d.includes('4x1000')||d.includes('gmf')||d.includes('impto gobierno')) return 'Registrar gasto GMF ‚Äî Cuenta 5305';
  if (d.includes('comision')||d.includes('cuota manejo')) return 'Registrar gasto bancario ‚Äî Cuenta 5305';
  if (d.includes('retefuente')||d.includes('retencion')) return 'Verificar contrapartida de retenci√≥n';
  return isDeb?'Identificar origen y registrar':'Identificar beneficiario y registrar';
}

function exportXls() {
  if (!resultados) return;
  const {matched, soloE, soloA, ext, aux, sE, sA, ssE, ssA, catsE} = resultados;
  const wb = XLSX.utils.book_new();
  const saldoE = sE.d - sE.c, saldoA = sA.d - sA.c;
  const metaE = extractMeta('E'), metaA = extractMeta('A');
  const empresa = metaA.empresa || metaE.empresa || '';
  const nit = metaA.nit || metaE.nit || '';
  const cuenta = metaE.cuenta || '';

  const soloE_in = soloE.filter(e => e.deb > 0), soloE_out = soloE.filter(e => e.cre > 0);
  const totEIn = soloE_in.reduce((s,e) => s+e.deb, 0), totEOut = soloE_out.reduce((s,e) => s+e.cre, 0);
  const soloA_deb = soloA.filter(a => a.deb > 0), soloA_cre = soloA.filter(a => a.cre > 0);
  const totADeb = soloA_deb.reduce((s,a) => s+a.deb, 0), totACre = soloA_cre.reduce((s,a) => s+a.cre, 0);

  /* ‚îÄ‚îÄ SHEET 1: Conciliaci√≥n Bancaria ‚îÄ‚îÄ */
  const s1 = [['CONCILIACI√ìN BANCARIA']];
  if (empresa) s1.push([empresa + (nit ? ' ‚Äî NIT ' + nit : '')]);
  if (cuenta) s1.push(['Cuenta No. ' + cuenta]);
  s1.push(['Generado: ' + new Date().toLocaleDateString('es-CO',{day:'2-digit',month:'long',year:'numeric'}) + ' ‚Äî Ex√≥genaDIAN']);
  s1.push([]);
  s1.push(['RESUMEN DE SALDOS']);
  s1.push(['Concepto','Extracto Bancario','Libros Contables','Diferencia','','Explicaci√≥n']);
  s1.push(['Total Ingresos / D√©bitos', sE.d, sA.d, sE.d - sA.d, '', '']);
  s1.push(['Total Egresos / Cr√©ditos', sE.c, sA.c, sE.c - sA.c, '', '']);
  s1.push(['Movimiento Neto del Per√≠odo', saldoE, saldoA, saldoE - saldoA]);
  s1.push([]);
  s1.push(['PARTIDAS CONCILIATORIAS']);
  s1.push(['PARTIDAS EN EXTRACTO NO REGISTRADAS EN LIBROS']);
  s1.push(['  (+) Ingresos en extracto sin registro contable', totEIn, soloE_in.length+' partidas']);
  s1.push(['  (‚àí) Egresos en extracto sin registro contable', -totEOut, soloE_out.length+' partidas']);
  s1.push(['  Subtotal partidas solo en extracto', totEIn - totEOut]);
  s1.push([]);
  s1.push(['PARTIDAS EN LIBROS NO REFLEJADAS EN EXTRACTO']);
  s1.push(['  (+) D√©bitos contables sin movimiento bancario', totADeb, soloA_deb.length+' partidas']);
  s1.push(['  (‚àí) Cr√©ditos contables sin movimiento bancario', totACre, soloA_cre.length+' partidas']);
  s1.push(['  Subtotal partidas solo en libros', totADeb - totACre]);
  s1.push([]);
  s1.push(['AN√ÅLISIS DE GASTOS E INGRESOS BANCARIOS']);
  s1.push(['Concepto','Movimientos','Valor']);
  const bkIds = ['gmf','comision','cuota','retefte','reteiva','reteica'];
  let tG = 0;
  for (const id of bkIds) { const c = catsE[id]; if(!c||!c.items.length) continue; tG += c.totalCre; s1.push([c.def.name, c.items.length, c.totalCre]); }
  s1.push(['Total gastos bancarios','',tG]);
  s1.push([]);
  const cI = catsE.interes;
  if (cI && cI.items.length) s1.push(['Intereses recibidos', cI.items.length, cI.totalDeb]);
  s1.push([]);
  s1.push(['ESTAD√çSTICAS']);
  s1.push(['Movimientos extracto', ext.length]);
  s1.push(['Movimientos auxiliar', aux.length]);
  s1.push(['Partidas conciliadas', matched.length]);
  s1.push(['Solo en extracto', soloE.length]);
  s1.push(['Solo en auxiliar', soloA.length]);
  s1.push(['% Conciliaci√≥n', Math.round(matched.length/Math.max(ext.length,aux.length)*100)+'%']);
  s1.push([],['Procesado 100% en navegador. Ex√≥genaDIAN no accedi√≥ a los datos.']);
  // Pad all rows to 6 columns so Explicaci√≥n column shows
  const s1w = 6;
  for (let i = 0; i < s1.length; i++) { while (s1[i].length < s1w) s1[i].push(''); }
  const ws1 = XLSX.utils.aoa_to_sheet(s1);
  ws1['!cols'] = [{wch:48},{wch:22},{wch:22},{wch:18},{wch:3},{wch:30}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Conciliaci√≥n Bancaria');

  /* ‚îÄ‚îÄ SHEET 2: Extracto sin Contabilizar ‚îÄ‚îÄ */
  const s2 = [
    ['PARTIDAS EN EXTRACTO BANCARIO NO REGISTRADAS EN LIBROS CONTABLES','','','','','',''],
    [soloE.length+' movimientos bancarios sin registro contable ‚Äî Requieren contabilizaci√≥n','','','','','',''],
    ['','','','','','',''],
    ['INGRESOS EN EXTRACTO SIN REGISTRO CONTABLE','','','','','',''],
    ['#','Fecha','Descripci√≥n','Valor','Tipo Probable','Acci√≥n Sugerida','Notas'],
  ];
  soloE_in.forEach((e,i) => s2.push([i+1, fD(e.fecha), e.desc, e.deb, tipoProbable(e.desc,true), accionSugerida(e.desc,true), '']));
  s2.push(['','','SUBTOTAL INGRESOS ('+soloE_in.length+' partidas)', totEIn,'','','']);
  s2.push(['','','','','','','']);
  s2.push(['EGRESOS EN EXTRACTO SIN REGISTRO CONTABLE','','','','','','']);
  s2.push(['#','Fecha','Descripci√≥n','Valor','Tipo Probable','Acci√≥n Sugerida','Notas']);
  soloE_out.forEach((e,i) => s2.push([i+1, fD(e.fecha), e.desc, -e.cre, tipoProbable(e.desc,false), accionSugerida(e.desc,false), '']));
  s2.push(['','','SUBTOTAL EGRESOS ('+soloE_out.length+' partidas)', -totEOut,'','','']);
  s2.push([]);
  s2.push(['','','TOTAL NETO SIN CONTABILIZAR', totEIn - totEOut,'','','']);
  const ws2 = XLSX.utils.aoa_to_sheet(s2);
  ws2['!cols'] = [{wch:5},{wch:12},{wch:42},{wch:16},{wch:26},{wch:38},{wch:22}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Extracto sin Contabilizar');

  /* ‚îÄ‚îÄ SHEET 3: Libros sin Extracto ‚îÄ‚îÄ */
  const s3 = [
    ['PARTIDAS EN LIBROS CONTABLES NO REFLEJADAS EN EXTRACTO BANCARIO','','','','','','','',''],
    [soloA.length+' registros contables sin movimiento bancario correspondiente','','','','','','','',''],
    ['','','','','','','','',''],
    ['#','Fecha','Comprobante','Tercero','Descripci√≥n','D√©bito','Cr√©dito','Posible Causa','Notas'],
  ];
  soloA.forEach((a,i) => {
    const causa = a.deb > 0 ? 'Verificar si tiene movimiento bancario asociado' : 'Verificar si pago fue procesado por el banco';
    s3.push([i+1, fD(a.fecha), a.ref, a.tercero, a.desc, a.deb||'', a.cre||'', causa, '']);
  });
  s3.push(['','','','TOTAL','', totADeb, totACre,'','']);
  const ws3 = XLSX.utils.aoa_to_sheet(s3);
  ws3['!cols'] = [{wch:5},{wch:12},{wch:14},{wch:38},{wch:30},{wch:16},{wch:16},{wch:42},{wch:22}];
  XLSX.utils.book_append_sheet(wb, ws3, 'Libros sin Extracto');

  /* ‚îÄ‚îÄ SHEET 4: Partidas Conciliadas ‚îÄ‚îÄ */
  const s4 = [
    ['PARTIDAS CONCILIADAS (MATCH EXTRACTO ‚Üî LIBROS)','','','','','','','','',''],
    [matched.length+' movimientos conciliados exitosamente','','','','','','','','',''],
    ['','','','','','','','','',''],
    ['Fecha Ext.','Descripci√≥n Extracto','Valor Extracto','Fecha Aux.','Comprobante','Tercero','D√©bito','Cr√©dito','Estado','Notas'],
  ];
  matched.forEach(m => {
    const e = ext[m.ei], a = aux[m.ai];
    const vE = e.deb > 0 ? e.deb : -e.cre;
    s4.push([fD(e.fecha), e.desc, vE, fD(a.fecha), a.ref, a.tercero, a.deb||'', a.cre||'', '‚úì OK', '']);
  });
  const ws4 = XLSX.utils.aoa_to_sheet(s4);
  ws4['!cols'] = [{wch:12},{wch:38},{wch:16},{wch:12},{wch:14},{wch:36},{wch:16},{wch:16},{wch:10},{wch:22}];
  XLSX.utils.book_append_sheet(wb, ws4, 'Partidas Conciliadas');

  XLSX.writeFile(wb, 'Conciliacion_'+new Date().toISOString().slice(0,10)+'.xlsx');
}

/* ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ */
function show(id){document.getElementById(id).classList.remove('hidden')}
function hide(id){document.getElementById(id).classList.add('hidden')}
function setSI(n){for(let i=1;i<=3;i++){const e=document.getElementById('si'+i);e.classList.remove('active','done');if(i<n)e.classList.add('done');if(i===n)e.classList.add('active')}}
function swTab(id,btn){document.querySelectorAll('.results-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.results-panel').forEach(p=>p.classList.remove('active'));btn.classList.add('active');document.getElementById('panel-'+id).classList.add('active')}
function fmtN(n){if(typeof n==='string')return n;if(typeof n!=='number'||isNaN(n))return'‚Äî';return Math.round(Math.abs(n)).toLocaleString('es-CO')}
function fD(d){if(!d)return'‚Äî';return d.toLocaleDateString('es-CO',{day:'2-digit',month:'short'})}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function sc(cls,val,lab){return`<div class="summary-card ${cls}"><div class="sc-val">${val}</div><div class="sc-label">${lab}</div></div>`}
</script>
</body>
</html>
